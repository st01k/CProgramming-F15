/*
*****************************************************************************************************************
*                                 Name:            Encoder/Decoder                                              *
*                                 Version:         0.1                                                          *
*                                 Chapter:         11.2, Assignment (p. 743, #43)                               *
*                                 Author:          Casey Murphy                                                 *
*                                 Date Created:    15 Nov 15                                                    *
*                                 Last Modified:   16 Nov 15                                                    *
* ------------------------------------------------------------------------------------------------------------- *
*  Menu driven encoder/decoder.  Reads key from file.                                                           *
*****************************************************************************************************************
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <stdbool.h>

#define FLUSH while (getchar() != '\n')
#define MAXLN 81
#define MAXCHAR 100

char menu    (void);
int  loadKey (char* alpha, char* code);
void decode  (char* alpha, char* code);
void encode  (char* alpha, char* code);
char repeat  (void);

int main (void)
{
    char menuSel;
    char again;
    char alpha[MAXCHAR];
    char code [MAXCHAR];

    menuSel = menu();
    if (menuSel == 'd') decode(alpha, code);
    if (menuSel == 'e') encode(alpha, code);
    again = repeat();

    return 0;
}

char menu()
{
    char input;

    puts("Message Encoder/Decoder Menu");
    puts("\nE) Encode a message\nD) Decode a message\nQ) Quit\n");
    printf("Enter your selection: ");
    scanf(" %c", &input);
    input = tolower(input);

    switch (input)
    {
        case 'd' :  break;
        case 'e' :  break;
        case 'q' :  exit (0);
                    break;
        default  :  while (input != 'd' && input != 'e')
                    {
                        printf("\aInvalid Response. Re-enter your answer: ");
                        scanf(" %c", &input);
                        if (input == 'q')
                            exit(0);
                    }
    }

    return input;
}

int loadKey(char* alpha, char* code)
{
    FILE* pFile;
    char cur;
    int i;

    if (!(pFile = fopen("key.txt", "r")))
    {
        printf ("Error opening file\n");
        exit (1);
    } // if file open error

    i = 0;
    while ((cur = fgetc(pFile)) != '\n')
    {
        alpha[i] = cur;
        i++;
    }

    i = 0;
    while ((cur = fgetc(pFile)) != EOF)
    {
        code[i] = cur;
        i++;
    }

    fclose(pFile);

    return strlen(alpha);  //returns 1 more than array amount for use in e/d loops
}

void decode(char* alpha, char* code)
{
    int max;
    int len;
    int diff;
    char* ptr;
    char message[MAXLN];
    char* pMsg = message;

    max = loadKey(alpha, code);

    printf("\nEnter the message to be decoded and press enter:\n\n");
    FLUSH;
    gets(message);

    char* english = message;
    len = strlen(message);

    for (int i = 0; i < len; i++)
    {
        ptr = strchr(code, message[i]);
        diff = ptr - code;
        english[i] = alpha[diff];
    }

    printf("\n%s\n", english);

    return;
}

void encode(char* alpha, char* code)
{
    int max;
    int len;
    int diff;
    char* ptr;
    char message[MAXLN];
    char* pMsg = message;

    max = loadKey(alpha, code);

    printf("\nEnter the message to be encoded and press enter:\n\n");
    FLUSH;
    gets(message);

    char* coded = message;
    len = strlen(message);

    for (int i = 0; i < len; i++)
    {
        ptr = strchr(alpha, message[i]);
        diff = ptr - alpha;
        coded[i] = code[diff];
    }

    printf("\n%s\n", coded);

    return;
}

char repeat(void)
{
    char input;
    
    printf("Would you like to run this program again (Y/N): ");
    scanf(" %c", &input);
    input = tolower(input);

    switch (input)
    {
        case 'y' :  break;
        case 'n' :  break;
        default  :  while (input != 'y' && input != 'e')
                    {
                        printf("\aInvalid Response. Re-enter your answer: ");
                        scanf(" %c", &input);
                        if (input == 'q')
                            exit(0);
                    }
    }
    
    
    return input;
}